{% extends "layout/basic.html" %}
{% block title %}IP 控制管理 - {{ contest.title }}{% endblock %}
{% block content %}
<style>
.ipc-wrapper{max-width:960px;margin:0 auto;padding:24px;font-size:14px;line-height:1.5;color:#2d3748}
.ipc-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:28px 32px;border-radius:14px 14px 0 0;position:relative;overflow:hidden}
.ipc-header h1{margin:0 0 4px;font-size:22px;font-weight:600}
.ipc-header p{margin:0;font-size:13px;opacity:.9}
.ipc-card{background:#fff;border:1px solid #e2e8f0;border-top:none;padding:24px 28px;border-radius:0 0 14px 14px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
.ipc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:8px}
.ipc-field{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:14px 16px}
.ipc-label{display:block;font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:#6b7280;margin-bottom:4px}
.ipc-value{font-size:14px;font-weight:500;word-break:break-all}
.ipc-status-on{color:#059669;font-weight:600}
.ipc-status-off{color:#dc2626;font-weight:600}
.ipc-toggle-form{margin-top:14px}
.ipc-btn{display:inline-flex;align-items:center;gap:6px;border:none;border-radius:8px;cursor:pointer;font-size:13px;padding:8px 16px;font-weight:500;transition:.25s;background:#4b5563;color:#fff}
.ipc-btn:hover{background:#374151}
.ipc-btn-primary{background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.ipc-btn-primary:hover{filter:brightness(1.05)}
.ipc-btn-danger{background:linear-gradient(135deg,#dc2626,#ef4444)}
.ipc-btn-danger:hover{filter:brightness(1.05)}
.ipc-section-title{margin:32px 0 12px;font-size:16px;font-weight:600;color:#374151;display:flex;align-items:center;gap:6px}
.ipc-textarea{width:100%;resize:vertical;min-height:120px;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-family:monospace;background:#f9fafb}
.ipc-meta{margin-top:8px;font-size:12px;color:#6b7280}
.ipc-lock-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
.ipc-lock-table th,.ipc-lock-table td{border:1px solid #e5e7eb;padding:6px 8px;vertical-align:top}
.ipc-lock-table th{background:#f3f4f6;font-weight:600;color:#374151;text-align:left}
.ipc-lock-ip{font-family:monospace;font-weight:600;color:#1f2937}
.ipc-ua{max-width:340px;white-space:normal;word-break:break-all;font-family:monospace;font-size:12px}
.ipc-empty{padding:28px 0;text-align:center;color:#6b7280;font-size:13px}
.ipc-flex{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.ipc-note-box{background:#f1f5f9;border:1px solid #e2e8f0;padding:12px 16px;border-radius:10px;font-size:12px;color:#475569}
@media (max-width:720px){.ipc-grid{grid-template-columns:1fr}.ipc-ua{max-width:200px}}
</style>
<div class="ipc-wrapper">
  <div class="ipc-header">
    <h1>IP 控制 · {{ contest.title }}</h1>
    <p>ID: {{ contest._id }} · 开始 {{ beginAtStr }} · 结束 {{ endAtStr }}</p>
  </div>
  <div class="ipc-card">
    <div class="ipc-grid">
      <div class="ipc-field"><span class="ipc-label">状态</span><span class="ipc-value">{% if contest.ipControlEnabled %}<span class="ipc-status-on">已开启</span>{% else %}<span class="ipc-status-off">未开启</span>{% endif %}</span></div>
      <div class="ipc-field"><span class="ipc-label">参赛人数 (attend)</span><span class="ipc-value">{{ imported }}</span></div>
    </div>
    <form method="post" class="ipc-toggle-form" style="display:inline-block;margin-right:8px">
      <input type="hidden" name="action" value="toggle"/>
      <input type="hidden" name="enabled" value="{{ not contest.ipControlEnabled }}"/>
      <button class="ipc-btn ipc-btn-primary" type="submit">{% if contest.ipControlEnabled %}关闭{% else %}开启{% endif %} 控制</button>
    </form>
    <form method="post" class="ipc-toggle-form" style="display:inline-block" onsubmit="return confirm('确认清除全部锁？');">
      <input type="hidden" name="action" value="clear_locks"/>
      <button class="ipc-btn ipc-btn-danger" type="submit">清除全部锁</button>
    </form>

    <h3 class="ipc-section-title">批量导入参赛 UID</h3>
    <form method="post">
      <input type="hidden" name="action" value="import_uids"/>
      <textarea name="uidsText" placeholder="1001 1002 1003 或换行/逗号/空格分隔" class="ipc-textarea"></textarea>
      <div class="ipc-flex">
        <button type="submit" class="ipc-btn ipc-btn-primary">导入</button>
      </div>
      <div class="ipc-meta">导入后自动设置 attend=1 & subscribe=1</div>
    </form>

    <h3 class="ipc-section-title">已绑定的 IP / UA</h3>
    {% if locks and locks.length > 0 %}
      <table class="ipc-lock-table">
        <thead>
          <tr><th style="width:70px">UID</th><th style="width:130px">IP</th><th>UA</th><th style="width:130px">首次绑定</th><th style="width:130px">最近</th><th style="width:72px">操作</th></tr>
        </thead>
        <tbody>
        {% for r in locks %}
          <tr>
            <td>{{ r.uid }}</td>
            <td class="ipc-lock-ip">{{ r.ip }}</td>
            <td class="ipc-ua">{{ r.ua }}</td>
            <td>{{ r.createdAtStr }}</td>
            <td>{{ r.updatedAtStr }}</td>
            <td>
              <form method="post" onsubmit="return confirm('解绑后用户可重新绑定。继续？');">
                <input type="hidden" name="action" value="unlock_lock"/>
                <input type="hidden" name="uid" value="{{ r.uid }}"/>
                <button class="ipc-btn" style="padding:4px 10px;font-size:12px" type="submit">解绑</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="ipc-empty">暂无锁定记录</div>
    {% endif %}

    <div class="ipc-section-title" style="margin-top:28px">说明</div>
    <div class="ipc-note-box">
      <ul style="margin:0;padding-left:18px">
        <li>比赛前 1 小时内禁止参赛用户登录。</li>
        <li>首次登录即锁定 IP + User-Agent；解绑后下次登录会重新绑定。</li>
        <li>清除全部锁仅对本场比赛生效。</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}
