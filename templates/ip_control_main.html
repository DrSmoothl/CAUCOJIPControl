{% extends "layout/basic.html" %}
{% block title %}IP控制管理{% endblock %}

{% block content %}
<div class="ipcontrol-main-container">
    <div class="row">
        <div class="medium-12 columns">
            <div class="section">
                <div class="section__header">
                    <h1 class="section__title">IP控制管理</h1>
                    <div class="section__tools">
                        <a href="/contest/list" class="ipcontrol-btn ipcontrol-btn-primary">
                            <i class="icon icon-plus"></i> 设置比赛IP控制
                        </a>
                    </div>
                </div>
                
                <div class="ipcontrol-stats-grid">
                    <div class="ipcontrol-stat-card">
                        <div class="ipcontrol-stat-number">{{ ipControlContests|length }}</div>
                        <div class="ipcontrol-stat-label">启用IP控制的比赛</div>
                    </div>
                    
                    <div class="ipcontrol-stat-card">
                        <div class="ipcontrol-stat-number">{{ recentViolations|length }}</div>
                        <div class="ipcontrol-stat-label">最近违规记录</div>
                    </div>
                </div>
            </div>

            {% if ipControlContests %}
            <div class="section">
                <div class="section__header">
                    <h2 class="section__title">启用IP控制的比赛</h2>
                </div>
                
                <div class="ipcontrol-contest-list">
                    {% for contest in ipControlContests %}
                    <div class="ipcontrol-contest-card">
                        <div class="ipcontrol-contest-header">
                            <h3 class="ipcontrol-contest-title">
                                <a href="/contest/{{ contest.contestId }}">{{ contest.title }}</a>
                            </h3>
                            <div class="ipcontrol-contest-status">
                                {% set now = moment() %}
                                {% set start = moment(contest.beginAt) %}
                                {% set end = moment(contest.endAt) %}
                                
                                {% if now < start %}
                                    <span class="ipcontrol-status ipcontrol-status-pending">未开始</span>
                                {% elif now >= start and now <= end %}
                                    <span class="ipcontrol-status ipcontrol-status-running">进行中</span>
                                {% else %}
                                    <span class="ipcontrol-status ipcontrol-status-ended">已结束</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="ipcontrol-contest-info">
                            <div class="ipcontrol-info-item">
                                <strong>开始时间:</strong> {{ moment(contest.beginAt).format('YYYY-MM-DD HH:mm:ss') }}
                            </div>
                            <div class="ipcontrol-info-item">
                                <strong>结束时间:</strong> {{ moment(contest.endAt).format('YYYY-MM-DD HH:mm:ss') }}
                            </div>
                            <div class="ipcontrol-info-item">
                                <strong>锁定时间:</strong> 比赛开始前 {{ contest.setting.preContestLockMinutes }} 分钟
                            </div>
                            <div class="ipcontrol-info-item">
                                <strong>检查模式:</strong> 
                                {% if contest.setting.strictMode %}
                                    <span class="ipcontrol-mode ipcontrol-mode-strict">严格模式 (IP+UA)</span>
                                {% else %}
                                    <span class="ipcontrol-mode ipcontrol-mode-loose">宽松模式 (仅IP)</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="ipcontrol-contest-actions">
                            <a href="/contest/{{ contest.contestId }}/ip-control" class="ipcontrol-btn ipcontrol-btn-secondary">
                                <i class="icon icon-edit"></i> 管理设置
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if recentViolations %}
            <div class="section">
                <div class="section__header">
                    <h2 class="section__title">最近违规记录</h2>
                    <div class="section__tools">
                        <a href="/ip-control/violations" class="ipcontrol-btn ipcontrol-btn-secondary">查看全部</a>
                    </div>
                </div>
                
                <div class="ipcontrol-table-responsive">
                    <table class="ipcontrol-table">
                        <thead>
                            <tr>
                                <th>用户</th>
                                <th>比赛</th>
                                <th>首次登录IP</th>
                                <th>违规次数</th>
                                <th>最后违规时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in recentViolations %}
                            <tr>
                                <td>
                                    {% if record.user %}
                                        <a href="/user/{{ record.user._id }}">{{ record.user.uname }}</a>
                                    {% else %}
                                        <span class="ipcontrol-text-muted">未知用户</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.contest %}
                                        <a href="/contest/{{ record.contest._id }}">{{ record.contest.title }}</a>
                                    {% else %}
                                        <span class="ipcontrol-text-muted">未知比赛</span>
                                    {% endif %}
                                </td>
                                <td><code>{{ record.firstLoginIP }}</code></td>
                                <td>
                                    <span class="ipcontrol-badge ipcontrol-badge-danger">{{ record.violations|length }}</span>
                                </td>
                                <td>
                                    {% if record.violations|length > 0 %}
                                        {{ moment(record.violations|last.timestamp).format('MM-DD HH:mm') }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {% if not ipControlContests and not recentViolations %}
            <div class="section">
                <div class="ipcontrol-empty-state">
                    <div class="ipcontrol-empty-icon">
                        <i class="icon icon-security"></i>
                    </div>
                    <h3>暂无IP控制设置</h3>
                    <p>您还没有为任何比赛启用IP控制功能。</p>
                    <a href="/contest/list" class="ipcontrol-btn ipcontrol-btn-primary">
                        开始设置IP控制
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.ipcontrol-main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.ipcontrol-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.ipcontrol-stat-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.ipcontrol-stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #3aa9de;
    margin-bottom: 8px;
}

.ipcontrol-stat-label {
    color: #666;
    font-size: 0.9em;
}

.ipcontrol-contest-list {
    display: grid;
    gap: 20px;
}

.ipcontrol-contest-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.ipcontrol-contest-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;
}

.ipcontrol-contest-title {
    margin: 0;
    font-size: 1.3em;
}

.ipcontrol-contest-title a {
    color: #333;
    text-decoration: none;
}

.ipcontrol-contest-title a:hover {
    color: #3aa9de;
}

.ipcontrol-contest-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}

.ipcontrol-info-item {
    font-size: 0.9em;
    color: #666;
}

.ipcontrol-contest-actions {
    display: flex;
    gap: 10px;
}

.ipcontrol-status {
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
}

.ipcontrol-status-pending {
    background: #ffeaa7;
    color: #d63031;
}

.ipcontrol-status-running {
    background: #55a3ff;
    color: white;
}

.ipcontrol-status-ended {
    background: #e0e0e0;
    color: #666;
}

.ipcontrol-mode {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
}

.ipcontrol-mode-strict {
    background: #ff7675;
    color: white;
}

.ipcontrol-mode-loose {
    background: #74b9ff;
    color: white;
}

.ipcontrol-table-responsive {
    overflow-x: auto;
}

.ipcontrol-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    background: #fff;
}

.ipcontrol-table th,
.ipcontrol-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.ipcontrol-table th {
    background: #f8f9fa;
    font-weight: bold;
}

.ipcontrol-table tr:hover {
    background: #f8f9fa;
}

.ipcontrol-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    font-weight: bold;
}

.ipcontrol-badge-danger {
    background: #ff7675;
    color: white;
}

.ipcontrol-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.2s;
}

.ipcontrol-btn-primary {
    background: #3aa9de;
    color: white;
}

.ipcontrol-btn-primary:hover {
    background: #2980b9;
    color: white;
}

.ipcontrol-btn-secondary {
    background: #e0e0e0;
    color: #333;
}

.ipcontrol-btn-secondary:hover {
    background: #d0d0d0;
    color: #333;
}

.ipcontrol-empty-state {
    text-align: center;
    padding: 60px 20px;
}

.ipcontrol-empty-icon {
    font-size: 4em;
    color: #ddd;
    margin-bottom: 20px;
}

.ipcontrol-text-muted {
    color: #999;
}
</style>
{% endblock %}
