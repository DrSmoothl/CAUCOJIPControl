# Hydro IP控制插件

## 简介

这是一个为Hydro在线评测系统开发的IP控制插件，旨在为比赛提供严格的IP和设备管理功能，防止参赛者在比赛期间更换设备或使用多个设备参赛。

## 主要功能

### 1. 比赛前IP控制
- **登录阻止**: 在比赛开始前阻止参赛者登录比赛页面
- **设备绑定**: 参赛者首次登录时自动绑定IP地址和用户代理（UA）
- **一致性检查**: 后续登录时验证IP和UA是否与首次登录一致

### 2. 强制参赛控制
- **强制模式**: 管理员可以设置某些用户必须参加比赛
- **自动报名**: 强制参赛用户无法取消报名
- **权限控制**: 只有管理员可以修改强制参赛设置

### 3. 管理员功能
- **IP控制设置**: 配置比赛的IP控制参数
- **违规记录查看**: 查看所有IP控制违规记录
- **用户登录记录管理**: 查看和清除用户的IP/UA绑定记录
- **强制参赛管理**: 设置和管理强制参赛用户列表

### 4. 违规检测与记录
- **实时监控**: 实时检测IP和UA变化
- **违规记录**: 记录所有违规行为，包括时间、IP、UA等详细信息
- **统计分析**: 提供违规统计和分析功能

## 安装方法

1. 将插件文件夹放置在Hydro的插件目录中
2. 在Hydro管理后台启用"IP控制插件"
3. 重启Hydro服务

## 使用指南

### 管理员操作

#### 1. 配置IP控制
1. 进入管理后台，找到"IP控制管理"
2. 为需要IP控制的比赛创建配置
3. 设置以下参数：
   - **启用状态**: 是否启用IP控制
   - **允许IP变化**: 是否允许IP地址变化（默认不允许）
   - **允许UA变化**: 是否允许用户代理变化（默认不允许）
   - **登录阻止时间**: 比赛开始前多长时间阻止登录
   - **违规行为**: 发现违规时的处理方式

#### 2. 管理比赛IP控制
1. 进入比赛管理页面
2. 找到"IP控制设置"选项卡
3. 可以查看：
   - 当前IP控制配置
   - 参赛用户登录记录
   - 违规记录统计
4. 可以执行：
   - 修改IP控制设置
   - 清除单个或多个用户的登录记录
   - 设置强制参赛用户

#### 3. 查看违规记录
1. 进入"违规记录"页面
2. 可以按比赛筛选违规记录
3. 查看详细的违规信息，包括：
   - 用户信息
   - 比赛信息
   - 违规时间
   - IP地址变化
   - 用户代理变化

#### 4. 用户登录记录管理
1. 在比赛IP控制页面查看所有用户的登录记录
2. 包含信息：用户ID、用户名、绑定IP、用户代理、首次登录时间、最后登录时间、登录次数、违规次数
3. 可以单个清除用户记录或批量清除多个用户记录
4. 清除记录后，用户可以使用新设备重新登录

### 参赛者体验

#### 1. 正常登录流程
1. 在比赛开始后使用指定设备登录
2. 首次登录时系统自动绑定IP和UA
3. 后续登录必须使用相同的网络环境和设备

#### 2. 设备更换处理
如果需要更换设备或网络环境：
1. 联系比赛管理员
2. 管理员可以清除该用户的登录记录
3. 用户可以使用新设备重新登录并绑定

## 技术实现

### 数据库集合

#### 1. ip_control_settings
存储比赛的IP控制配置信息
```typescript
{
  contestId: ObjectId,      // 比赛ID
  enabled: boolean,         // 是否启用
  allowIPChange: boolean,   // 允许IP变化
  allowUAChange: boolean,   // 允许UA变化
  blockTime: number,        // 阻止登录时间(分钟)
  violation: string,        // 违规处理方式
  createdAt: Date,          // 创建时间
  updatedAt: Date           // 更新时间
}
```

#### 2. ip_control_records
存储用户登录和违规记录
```typescript
{
  uid: number,              // 用户ID
  contestId: ObjectId,      // 比赛ID
  type: string,             // 记录类型(login/violation)
  ip: string,               // IP地址
  userAgent: string,        // 用户代理
  timestamp: Date,          // 时间戳
  details: object           // 详细信息
}
```

#### 3. contest_participants
扩展原有参赛者信息
```typescript
{
  // ... 原有字段
  firstLoginIP?: string,     // 首次登录IP
  firstLoginUA?: string,     // 首次登录UA
  firstLoginAt?: Date,       // 首次登录时间
  lastLoginAt?: Date,        // 最后登录时间
  loginCount?: number,       // 登录次数
  violationCount?: number,   // 违规次数
  forced?: boolean           // 是否强制参赛
}
```

### API接口

#### 1. IP控制设置
- `GET /contest/:contestId/ip-control` - 获取设置页面
- `POST /contest/:contestId/ip-control` - 保存设置

#### 2. 违规记录
- `GET /ip-control/violations` - 获取违规记录

#### 3. 用户登录记录管理
- `POST /contest/:contestId/ip-control` (action: clear_login_records) - 批量清除
- `POST /contest/:contestId/ip-control` (action: clear_single_record) - 单个清除

## 安全考虑

1. **权限控制**: 只有管理员可以访问IP控制功能
2. **数据加密**: 敏感信息进行适当的加密存储
3. **日志记录**: 所有关键操作都有详细的日志记录
4. **防绕过**: 多层验证确保无法绕过IP控制

## 兼容性

- **Hydro版本**: 适用于Hydro 4.0及以上版本
- **浏览器**: 支持所有现代浏览器
- **数据库**: 兼容MongoDB 4.0及以上版本

## 许可证

本插件采用AGPL-3.0许可证开源。

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 实现基本的IP控制功能
- 提供管理员界面
- 支持违规记录查看
- 添加用户登录记录管理功能
- 解决CSS类名冲突问题
- 完善时间处理和模板渲染

## 技术支持

如有问题或建议，请提交Issue或联系开发团队。

## 作者

DrSmoothl
