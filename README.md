# IP控制插件 (IP Control Plugin)

这是一个为Hydro在线评测系统开发的IP控制插件，主要用于比赛期间的IP控制和用户强制参赛管理。

## 功能特性

### 1. 比赛IP控制
- **登录锁定**: 比赛开始前可配置时间内禁止参赛用户登录
- **IP一致性检查**: 要求用户在比赛期间使用相同的IP地址登录
- **严格模式**: 可选择检查IP+UserAgent或仅检查IP
- **违规记录**: 自动记录和展示所有IP控制违规行为
- **强制下线**: 违规用户自动被强制下线

### 2. 用户强制参赛
- **批量导入**: 支持通过用户ID列表批量添加强制参赛用户
- **权限控制**: 只有管理员可以管理强制参赛用户
- **自动注册**: 强制参赛用户自动注册参加比赛

### 3. 管理界面
- **直观的管理界面**: 提供友好的Web管理界面
- **实时状态展示**: 显示比赛状态、锁定期等信息
- **违规记录查看**: 详细的违规记录查看和筛选功能

## 安装和配置

### 1. 安装依赖
```bash
cd /path/to/hydro/plugins/ip-control-plugin
pnpm install
```

### 2. 启用插件
在Hydro的插件配置中启用此插件。

### 3. 数据库集合
插件会自动创建以下MongoDB集合：
- `ip_control_settings`: IP控制设置
- `ip_control_records`: IP控制记录
- `contest_participants`: 强制参赛用户

## 使用说明

### 1. 为比赛启用IP控制

1. 进入比赛详情页面
2. 点击右上角的"IP控制设置"按钮（需要系统管理员权限）
3. 配置以下设置：
   - **启用IP控制**: 是否启用IP控制功能
   - **锁定时间**: 比赛开始前多少分钟禁止登录（默认60分钟）
   - **检查模式**: 
     - 严格模式：检查IP地址和UserAgent
     - 宽松模式：仅检查IP地址
   - **允许的IP范围**: （可选）限制允许的IP地址范围

### 2. 管理强制参赛用户

在IP控制设置页面的"强制参赛用户管理"部分：

1. **添加用户**: 在文本框中输入用户ID列表，每行一个
2. **查看用户**: 查看当前所有强制参赛用户
3. **移除用户**: 点击"移除"按钮移除不需要的用户

### 3. 查看违规记录

1. 访问 `/ip-control/violations` 页面
2. 可以按比赛筛选违规记录
3. 查看详细的违规信息，包括：
   - 用户信息
   - 首次登录IP和UserAgent
   - 违规时的IP和UserAgent
   - 违规时间

## 工作流程

### 比赛前
1. 管理员为比赛启用IP控制
2. 设置锁定时间（如比赛前60分钟）
3. 添加强制参赛用户列表

### 锁定期（比赛前n分钟）
1. 系统禁止所有参赛用户登录
2. 已登录用户被强制下线
3. 登录页面显示锁定提示

### 比赛期间
1. 用户首次登录时记录IP和UserAgent
2. 后续登录检查IP/UserAgent一致性
3. 违规登录被阻止并记录
4. 违规用户被强制下线

### 比赛后
1. IP控制自动解除
2. 违规记录保留供后续查看
3. 管理员可以分析违规情况

## 安全特性

1. **多层验证**: IP地址和浏览器指纹双重验证
2. **实时监控**: 实时检测和阻止违规行为
3. **详细日志**: 完整的操作和违规日志记录
4. **权限控制**: 只有系统管理员可以配置IP控制

## 注意事项

1. **网络环境**: 确保比赛用户在稳定的网络环境下参赛
2. **浏览器**: 建议用户在比赛期间不要更换浏览器
3. **代理/VPN**: 禁止使用代理或VPN参赛
4. **时间同步**: 确保服务器时间准确

## 技术实现

- **后端**: TypeScript + MongoDB
- **前端**: Nunjucks模板 + 自定义CSS
- **事件系统**: 基于Hydro的事件系统实现登录拦截
- **数据库**: 使用MongoDB存储设置和记录

## 错误处理

如果遇到问题，请检查：

1. **插件是否正确安装**: 确认package.json中的依赖已安装
2. **权限设置**: 确认用户有系统管理员权限
3. **数据库连接**: 确认MongoDB连接正常
4. **时间设置**: 确认服务器时间准确

## 更新日志

### v1.0.0
- 初始版本发布
- 基本IP控制功能
- 强制参赛用户管理
- 违规记录查看

## 许可证

AGPL-3.0-only

## 作者

DrSmoothl

## 支持

如有问题或建议，请联系插件作者。
